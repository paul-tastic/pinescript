//mach2fx - NEXUS STRATEGY V3
//@version=5
// ============================================================================
// Nexus Strategy v3 - MSS Order Block Trading System
// ============================================================================
// Built from clean HTF-Sessions-FVG-SupplyDemand-Baseline
// Adds:
// - LTF Fractals for MSS detection
// - Engulfing Order Block detection in HTF S&D zones
// - MSS Order Block confirmation (LTF fractal break + Engulfing)
// - Trade execution with TP/SL management
// - No-trade time periods
// ============================================================================
strategy("Nexus Strategy v3", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500, default_qty_type=strategy.fixed, default_qty_value=1, initial_capital=10000, currency=currency.USD)

// ============================================================================
// INPUTS
// ============================================================================

// Session Time Settings (NY Timezone)
asian_session = input.session("2000-0000", "Asian Session", group="Session Times")
london_session = input.session("0300-0700", "London Session", group="Session Times")
ny_session = input.session("0930-1600", "NY Session", group="Session Times")

// Session High/Low Display Settings
show_asian_lines = input.bool(true, "Show Asian Session Lines", group="Session Lines")
show_london_lines = input.bool(true, "Show London Session Lines", group="Session Lines")
show_ny_lines = input.bool(true, "Show NY Session Lines", group="Session Lines")
show_labels = input.bool(true, "Show Session Labels", group="Session Lines")

// Visual Settings
session_high_color = input.color(color.new(color.red, 0), "Session High Color", group="Visual")
session_low_color = input.color(color.new(color.green, 0), "Session Low Color", group="Visual")

// Fractal Settings
show_fractals = input.bool(true, "Show HTF (1H) Fractals", group="Fractals")
fractal_up_color = input.color(color.new(color.lime, 0), "HTF Fractal Up Color", group="Fractals")
fractal_down_color = input.color(color.new(color.red, 0), "HTF Fractal Down Color", group="Fractals")
show_ltf_fractals = input.bool(true, "Show LTF (Chart TF) Fractals", group="Fractals")
ltf_fractal_up_color = input.color(color.new(color.aqua, 0), "LTF Fractal Up Color", group="Fractals")
ltf_fractal_down_color = input.color(color.new(color.orange, 0), "LTF Fractal Down Color", group="Fractals")

// HTF Supply & Demand Settings
show_htf_supply_demand = input.bool(true, "Show HTF Supply & Demand Zones", group="HTF Supply & Demand")
htf_demand_color = input.color(color.new(color.green, 90), "HTF Demand Zone Color", group="HTF Supply & Demand")
htf_supply_color = input.color(color.new(color.red, 90), "HTF Supply Zone Color", group="HTF Supply & Demand")
max_htf_sd_zones = input.int(10, "Max HTF S&D Zones", minval=1, maxval=50, group="HTF Supply & Demand")

// Trade Management
show_trade_zones = input.bool(true, "Show TP/SL Trade Zones", group="Trade Management")
tp_rr_ratio = input.float(2.0, "TP Risk/Reward Ratio", minval=0.5, maxval=10.0, step=0.5, group="Trade Management")
show_debug_table = input.bool(true, "Show Debug Table", group="Trade Management")

// No-Trade Times
enable_no_trade_1 = input.bool(true, "Enable No-Trade Period 1", group="No-Trade Times")
no_trade_1_start = input.session("1745-1815", "Period 1 Time", group="No-Trade Times")
enable_no_trade_2 = input.bool(true, "Enable No-Trade Period 2", group="No-Trade Times")
no_trade_2_start = input.session("1815-2359", "Period 2 Time", group="No-Trade Times")
enable_no_trade_3 = input.bool(true, "Enable No-Trade Period 3", group="No-Trade Times")
no_trade_3_start = input.session("0000-0930", "Period 3 Time", group="No-Trade Times")

// ============================================================================
// VARIABLES
// ============================================================================

// Asian Session Variables
var float prev_asian_high = na
var float prev_asian_low = na
var int prev_asian_high_time = na
var int prev_asian_low_time = na
var line asian_high_line = na
var line asian_low_line = na
var label asian_high_label = na
var label asian_low_label = na
var bool asian_high_invalidated = false
var bool asian_low_invalidated = false
var float current_asian_high = na
var float current_asian_low = na
var int current_asian_high_time = na
var int current_asian_low_time = na
var bool in_asian_session = false

// London Session Variables
var float prev_london_high = na
var float prev_london_low = na
var int prev_london_high_time = na
var int prev_london_low_time = na
var line london_high_line = na
var line london_low_line = na
var label london_high_label = na
var label london_low_label = na
var bool london_high_invalidated = false
var bool london_low_invalidated = false
var float current_london_high = na
var float current_london_low = na
var int current_london_high_time = na
var int current_london_low_time = na
var bool in_london_session = false

// NY Session Variables
var float prev_ny_high = na
var float prev_ny_low = na
var int prev_ny_high_time = na
var int prev_ny_low_time = na
var line ny_high_line = na
var line ny_low_line = na
var label ny_high_label = na
var label ny_low_label = na
var bool ny_high_invalidated = false
var bool ny_low_invalidated = false
var float current_ny_high = na
var float current_ny_low = na
var int current_ny_high_time = na
var int current_ny_low_time = na
var bool in_ny_session = false

var int current_day = na

// HTF Supply & Demand Variables
var array<box> htf_demand_zones = array.new<box>()
var array<box> htf_supply_zones = array.new<box>()
var array<float> demand_tops = array.new<float>()
var array<float> demand_bottoms = array.new<float>()
var array<float> supply_tops = array.new<float>()
var array<float> supply_bottoms = array.new<float>()

// HTF Fractals
var array<float> fractal_highs = array.new<float>()
var array<int> fractal_highs_time = array.new<int>()
var array<float> fractal_highs_low = array.new<float>()
var array<float> fractal_lows = array.new<float>()
var array<int> fractal_lows_time = array.new<int>()
var array<float> fractal_lows_high = array.new<float>()
var array<int> broken_highs = array.new<int>()
var array<int> broken_lows = array.new<int>()
var array<int> invalidated_highs = array.new<int>()
var array<int> invalidated_lows = array.new<int>()

// LTF Fractals for MSS detection
var array<float> ltf_fh_prices = array.new<float>()
var array<bool> ltf_fh_broken_flags = array.new<bool>()
var array<float> ltf_fl_prices = array.new<float>()
var array<bool> ltf_fl_broken_flags = array.new<bool>()

// Trade Management
var bool in_long_trade = false
var bool in_short_trade = false
var float long_entry_price = na
var float short_entry_price = na
var float long_tp_price = na
var float long_sl_price = na
var float short_tp_price = na
var float short_sl_price = na
var line long_tp_line = na
var line long_sl_line = na
var line short_tp_line = na
var line short_sl_line = na

// ============================================================================
// SESSION DETECTION
// ============================================================================

bool is_no_trade_time = (enable_no_trade_1 and not na(time(timeframe.period, no_trade_1_start, "America/New_York"))) or (enable_no_trade_2 and not na(time(timeframe.period, no_trade_2_start, "America/New_York"))) or (enable_no_trade_3 and not na(time(timeframe.period, no_trade_3_start, "America/New_York")))

bool is_asian = not na(time(timeframe.period, asian_session, "America/New_York"))
bool is_london = not na(time(timeframe.period, london_session, "America/New_York"))
bool is_ny = not na(time(timeframe.period, ny_session, "America/New_York"))

int today = dayofweek(time, "America/New_York")
bool is_new_day = na(current_day) or today != current_day

if is_new_day
    current_day := today

// ============================================================================
// ASIAN SESSION HIGH/LOW TRACKING
// ============================================================================

if is_asian and not in_asian_session
    in_asian_session := true
    current_asian_high := high
    current_asian_low := low
    current_asian_high_time := time
    current_asian_low_time := time

if in_asian_session and is_asian
    if high > current_asian_high
        current_asian_high := high
        current_asian_high_time := time
    if low < current_asian_low
        current_asian_low := low
        current_asian_low_time := time

if in_asian_session and not is_asian
    in_asian_session := false
    prev_asian_high := current_asian_high
    prev_asian_low := current_asian_low
    prev_asian_high_time := current_asian_high_time
    prev_asian_low_time := current_asian_low_time
    asian_high_invalidated := false
    asian_low_invalidated := false

    if show_asian_lines
        if not na(asian_high_line)
            line.delete(asian_high_line)
        if not na(asian_low_line)
            line.delete(asian_low_line)
        if not na(asian_high_label)
            label.delete(asian_high_label)
        if not na(asian_low_label)
            label.delete(asian_low_label)

        if not na(prev_asian_high)
            asian_high_line := line.new(prev_asian_high_time, prev_asian_high, prev_asian_high_time + 1, prev_asian_high, xloc=xloc.bar_time, extend=extend.right, color=session_high_color, width=2, style=line.style_solid)
            if show_labels
                asian_high_label := label.new(prev_asian_high_time, prev_asian_high, "PAH", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_high_color, size=size.small)

        if not na(prev_asian_low)
            asian_low_line := line.new(prev_asian_low_time, prev_asian_low, prev_asian_low_time + 1, prev_asian_low, xloc=xloc.bar_time, extend=extend.right, color=session_low_color, width=2, style=line.style_solid)
            if show_labels
                asian_low_label := label.new(prev_asian_low_time, prev_asian_low, "PAL", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_low_color, size=size.small)

// ============================================================================
// LONDON SESSION HIGH/LOW TRACKING
// ============================================================================

if is_london and not in_london_session
    in_london_session := true
    current_london_high := high
    current_london_low := low
    current_london_high_time := time
    current_london_low_time := time

if in_london_session and is_london
    if high > current_london_high
        current_london_high := high
        current_london_high_time := time
    if low < current_london_low
        current_london_low := low
        current_london_low_time := time

if in_london_session and not is_london
    in_london_session := false
    prev_london_high := current_london_high
    prev_london_low := current_london_low
    prev_london_high_time := current_london_high_time
    prev_london_low_time := current_london_low_time
    london_high_invalidated := false
    london_low_invalidated := false

    if show_london_lines
        if not na(london_high_line)
            line.delete(london_high_line)
        if not na(london_low_line)
            line.delete(london_low_line)
        if not na(london_high_label)
            label.delete(london_high_label)
        if not na(london_low_label)
            label.delete(london_low_label)

        if not na(prev_london_high)
            london_high_line := line.new(prev_london_high_time, prev_london_high, prev_london_high_time + 1, prev_london_high, xloc=xloc.bar_time, extend=extend.right, color=session_high_color, width=2, style=line.style_solid)
            if show_labels
                london_high_label := label.new(prev_london_high_time, prev_london_high, "PLH", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_high_color, size=size.small)

        if not na(prev_london_low)
            london_low_line := line.new(prev_london_low_time, prev_london_low, prev_london_low_time + 1, prev_london_low, xloc=xloc.bar_time, extend=extend.right, color=session_low_color, width=2, style=line.style_solid)
            if show_labels
                london_low_label := label.new(prev_london_low_time, prev_london_low, "PLL", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_low_color, size=size.small)

// ============================================================================
// NY SESSION HIGH/LOW TRACKING
// ============================================================================

if is_ny and not in_ny_session
    in_ny_session := true
    current_ny_high := high
    current_ny_low := low
    current_ny_high_time := time
    current_ny_low_time := time

if in_ny_session and is_ny
    if high > current_ny_high
        current_ny_high := high
        current_ny_high_time := time
    if low < current_ny_low
        current_ny_low := low
        current_ny_low_time := time

if in_ny_session and not is_ny
    in_ny_session := false
    prev_ny_high := current_ny_high
    prev_ny_low := current_ny_low
    prev_ny_high_time := current_ny_high_time
    prev_ny_low_time := current_ny_low_time
    ny_high_invalidated := false
    ny_low_invalidated := false

    if show_ny_lines
        if not na(ny_high_line)
            line.delete(ny_high_line)
        if not na(ny_low_line)
            line.delete(ny_low_line)
        if not na(ny_high_label)
            label.delete(ny_high_label)
        if not na(ny_low_label)
            label.delete(ny_low_label)

        if not na(prev_ny_high)
            ny_high_line := line.new(prev_ny_high_time, prev_ny_high, prev_ny_high_time + 1, prev_ny_high, xloc=xloc.bar_time, extend=extend.right, color=session_high_color, width=2, style=line.style_solid)
            if show_labels
                ny_high_label := label.new(prev_ny_high_time, prev_ny_high, "PNH", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_high_color, size=size.small)

        if not na(prev_ny_low)
            ny_low_line := line.new(prev_ny_low_time, prev_ny_low, prev_ny_low_time + 1, prev_ny_low, xloc=xloc.bar_time, extend=extend.right, color=session_low_color, width=2, style=line.style_solid)
            if show_labels
                ny_low_label := label.new(prev_ny_low_time, prev_ny_low, "PNL", xloc=xloc.bar_time, style=label.style_none, color=color.new(color.white, 100), textcolor=session_low_color, size=size.small)

// ============================================================================
// LINE INVALIDATION
// ============================================================================

if not na(asian_high_line) and not asian_high_invalidated and not na(prev_asian_high)
    if high > prev_asian_high
        asian_high_invalidated := true
        line.delete(asian_high_line)
        asian_high_line := na
        if not na(asian_high_label)
            label.delete(asian_high_label)
            asian_high_label := na

if not na(asian_low_line) and not asian_low_invalidated and not na(prev_asian_low)
    if low < prev_asian_low
        asian_low_invalidated := true
        line.delete(asian_low_line)
        asian_low_line := na
        if not na(asian_low_label)
            label.delete(asian_low_label)
            asian_low_label := na

if not na(london_high_line) and not london_high_invalidated and not na(prev_london_high)
    if high > prev_london_high
        london_high_invalidated := true
        line.delete(london_high_line)
        london_high_line := na
        if not na(london_high_label)
            label.delete(london_high_label)
            london_high_label := na

if not na(london_low_line) and not london_low_invalidated and not na(prev_london_low)
    if low < prev_london_low
        london_low_invalidated := true
        line.delete(london_low_line)
        london_low_line := na
        if not na(london_low_label)
            label.delete(london_low_label)
            london_low_label := na

if not na(ny_high_line) and not ny_high_invalidated and not na(prev_ny_high)
    if high > prev_ny_high
        ny_high_invalidated := true
        line.delete(ny_high_line)
        ny_high_line := na
        if not na(ny_high_label)
            label.delete(ny_high_label)
            ny_high_label := na

if not na(ny_low_line) and not ny_low_invalidated and not na(prev_ny_low)
    if low < prev_ny_low
        ny_low_invalidated := true
        line.delete(ny_low_line)
        ny_low_line := na
        if not na(ny_low_label)
            label.delete(ny_low_label)
            ny_low_label := na

// ============================================================================
// WILLIAMS FRACTALS - HTF (1H)
// ============================================================================

// Get 1H data using request.security (runs on ALL timeframes)
htf_fractal_high_0 = request.security(syminfo.tickerid, "60", high[0], gaps=barmerge.gaps_on)
htf_fractal_high_1 = request.security(syminfo.tickerid, "60", high[1], gaps=barmerge.gaps_on)
htf_fractal_high_2 = request.security(syminfo.tickerid, "60", high[2], gaps=barmerge.gaps_on)
htf_fractal_high_3 = request.security(syminfo.tickerid, "60", high[3], gaps=barmerge.gaps_on)
htf_fractal_high_4 = request.security(syminfo.tickerid, "60", high[4], gaps=barmerge.gaps_on)

htf_fractal_low_0 = request.security(syminfo.tickerid, "60", low[0], gaps=barmerge.gaps_on)
htf_fractal_low_1 = request.security(syminfo.tickerid, "60", low[1], gaps=barmerge.gaps_on)
htf_fractal_low_2 = request.security(syminfo.tickerid, "60", low[2], gaps=barmerge.gaps_on)
htf_fractal_low_3 = request.security(syminfo.tickerid, "60", low[3], gaps=barmerge.gaps_on)
htf_fractal_low_4 = request.security(syminfo.tickerid, "60", low[4], gaps=barmerge.gaps_on)

htf_fractal_time_2 = request.security(syminfo.tickerid, "60", time[2], gaps=barmerge.gaps_on)

// Check if current chart timeframe is at or above 60 minutes
bool is_htf_chart = timeframe.in_seconds() >= 3600

// Detect fractals from 1H data (runs on ALL timeframes for S&D zone creation)
bool htf_fractal_up_detected = not na(htf_fractal_high_2) and htf_fractal_high_2 > htf_fractal_high_4 and htf_fractal_high_2 > htf_fractal_high_3 and htf_fractal_high_2 > htf_fractal_high_1 and htf_fractal_high_2 > htf_fractal_high_0
bool htf_fractal_down_detected = not na(htf_fractal_low_2) and htf_fractal_low_2 < htf_fractal_low_4 and htf_fractal_low_2 < htf_fractal_low_3 and htf_fractal_low_2 < htf_fractal_low_1 and htf_fractal_low_2 < htf_fractal_low_0

// Only plot fractals when chart is 1H or higher (to avoid clutter on LTF)
bool htf_fractal_up = show_fractals and is_htf_chart and htf_fractal_up_detected
bool htf_fractal_down = show_fractals and is_htf_chart and htf_fractal_down_detected

if htf_fractal_up_detected
    array.push(fractal_highs, htf_fractal_high_2)
    array.push(fractal_highs_time, htf_fractal_time_2)
    array.push(fractal_highs_low, htf_fractal_low_2)

    if array.size(fractal_highs) > 50
        array.shift(fractal_highs)
        array.shift(fractal_highs_time)
        array.shift(fractal_highs_low)

if htf_fractal_down_detected
    array.push(fractal_lows, htf_fractal_low_2)
    array.push(fractal_lows_time, htf_fractal_time_2)
    array.push(fractal_lows_high, htf_fractal_high_2)

    if array.size(fractal_lows) > 50
        array.shift(fractal_lows)
        array.shift(fractal_lows_time)
        array.shift(fractal_lows_high)

// Plot HTF fractals with small triangles
plotshape(htf_fractal_up, title="HTF Fractal Up", style=shape.triangledown, location=location.abovebar, color=fractal_down_color, size=size.tiny, offset=-2)
plotshape(htf_fractal_down, title="HTF Fractal Down", style=shape.triangleup, location=location.belowbar, color=fractal_up_color, size=size.tiny, offset=-2)

// ============================================================================
// LTF FRACTALS (CHART TIMEFRAME)
// ============================================================================

bool is_ltf_chart = timeframe.in_seconds() < 3600
bool ltf_fractal_up_detected = show_ltf_fractals and is_ltf_chart and barstate.isconfirmed and bar_index > 4 and high[2] > high[4] and high[2] > high[3] and high[2] > high[1]
bool ltf_fractal_down_detected = show_ltf_fractals and is_ltf_chart and barstate.isconfirmed and bar_index > 4 and low[2] < low[4] and low[2] < low[3] and low[2] < low[1]

// Plot LTF fractals
plotshape(ltf_fractal_up_detected, title="LTF Fractal Up", style=shape.triangledown, location=location.abovebar, color=ltf_fractal_down_color, size=size.auto, offset=-2)
plotshape(ltf_fractal_down_detected, title="LTF Fractal Down", style=shape.triangleup, location=location.belowbar, color=ltf_fractal_up_color, size=size.auto, offset=-2)

// Store LTF fractals for MSS detection
if ltf_fractal_up_detected
    array.push(ltf_fh_prices, high[2])
    array.push(ltf_fh_broken_flags, false)

    if array.size(ltf_fh_prices) > 30
        array.shift(ltf_fh_prices)
        array.shift(ltf_fh_broken_flags)

if ltf_fractal_down_detected
    array.push(ltf_fl_prices, low[2])
    array.push(ltf_fl_broken_flags, false)

    if array.size(ltf_fl_prices) > 30
        array.shift(ltf_fl_prices)
        array.shift(ltf_fl_broken_flags)

// ============================================================================
// HTF SUPPLY & DEMAND ZONES (Simplified from baseline)
// ============================================================================

htf_1h_close = request.security(syminfo.tickerid, "60", close, lookahead=barmerge.lookahead_off)

// Simplified S&D: Create zones when 1H closes above fractal highs or below fractal lows
if show_htf_supply_demand and bar_index > 2
    // Demand zones: 1H closes above fractal high
    if htf_fractal_up_detected
        zone_top = htf_fractal_high_2
        zone_bottom = htf_fractal_high_2 * 0.9985  // 0.15% range

        demand_box = box.new(htf_fractal_time_2, zone_top, time + (60 * 60 * 1000 * 100), zone_bottom, border_color=color.new(htf_demand_color, 50), bgcolor=htf_demand_color, border_width=2, xloc=xloc.bar_time)
        array.push(htf_demand_zones, demand_box)
        array.push(demand_tops, zone_top)
        array.push(demand_bottoms, zone_bottom)

        if array.size(htf_demand_zones) > max_htf_sd_zones
            old_box = array.shift(htf_demand_zones)
            box.delete(old_box)
            array.shift(demand_tops)
            array.shift(demand_bottoms)

    // Supply zones: 1H closes below fractal low
    if htf_fractal_down_detected
        zone_bottom = htf_fractal_low_2
        zone_top = htf_fractal_low_2 * 1.0015  // 0.15% range

        supply_box = box.new(htf_fractal_time_2, zone_top, time + (60 * 60 * 1000 * 100), zone_bottom, border_color=color.new(htf_supply_color, 50), bgcolor=htf_supply_color, border_width=2, xloc=xloc.bar_time)
        array.push(htf_supply_zones, supply_box)
        array.push(supply_tops, zone_top)
        array.push(supply_bottoms, zone_bottom)

        if array.size(htf_supply_zones) > max_htf_sd_zones
            old_box = array.shift(htf_supply_zones)
            box.delete(old_box)
            array.shift(supply_tops)
            array.shift(supply_bottoms)

// Extend S&D zones to current time
if array.size(htf_supply_zones) > 0
    for i = 0 to array.size(htf_supply_zones) - 1
        box.set_right(array.get(htf_supply_zones, i), time)

if array.size(htf_demand_zones) > 0
    for i = 0 to array.size(htf_demand_zones) - 1
        box.set_right(array.get(htf_demand_zones, i), time)

// Invalidate zones when price closes through them
if array.size(htf_demand_zones) > 0
    for i = array.size(htf_demand_zones) - 1 to 0
        if close < array.get(demand_bottoms, i)
            box.delete(array.get(htf_demand_zones, i))
            array.remove(htf_demand_zones, i)
            array.remove(demand_tops, i)
            array.remove(demand_bottoms, i)

if array.size(htf_supply_zones) > 0
    for i = array.size(htf_supply_zones) - 1 to 0
        if close > array.get(supply_tops, i)
            box.delete(array.get(htf_supply_zones, i))
            array.remove(htf_supply_zones, i)
            array.remove(supply_tops, i)
            array.remove(supply_bottoms, i)

// ============================================================================
// ENGULFING ORDER BLOCK DETECTION
// ============================================================================

var bool bullish_engulfing_in_demand = false
var float bullish_ob_top = na
var float bullish_ob_bottom = na

var bool bearish_engulfing_in_supply = false
var float bearish_ob_top = na
var float bearish_ob_bottom = na

if barstate.isconfirmed
    bullish_engulfing_in_demand := false
    bearish_engulfing_in_supply := false

    // Bullish Engulfing
    bool is_bullish_engulfing = close > open and close[1] < open[1] and open <= close[1] and close >= open[1]

    if is_bullish_engulfing and array.size(htf_demand_zones) > 0
        for i = 0 to array.size(htf_demand_zones) - 1
            if low >= array.get(demand_bottoms, i) and high <= array.get(demand_tops, i)
                bullish_engulfing_in_demand := true
                bullish_ob_top := math.max(open[1], close[1])
                bullish_ob_bottom := math.min(open[1], close[1])
                break

    // Bearish Engulfing
    bool is_bearish_engulfing = close < open and close[1] > open[1] and open >= close[1] and close <= open[1]

    if is_bearish_engulfing and array.size(htf_supply_zones) > 0
        for i = 0 to array.size(htf_supply_zones) - 1
            if low >= array.get(supply_bottoms, i) and high <= array.get(supply_tops, i)
                bearish_engulfing_in_supply := true
                bearish_ob_top := math.max(open[1], close[1])
                bearish_ob_bottom := math.min(open[1], close[1])
                break

plotshape(bullish_engulfing_in_demand, "Bullish Engulfing OB", shape.labelup, location.belowbar, color.new(color.green, 0), text="ENG", textcolor=color.white, size=size.small)
plotshape(bearish_engulfing_in_supply, "Bearish Engulfing OB", shape.labeldown, location.abovebar, color.new(color.red, 0), text="ENG", textcolor=color.white, size=size.small)

// ============================================================================
// MSS ORDER BLOCK DETECTION
// ============================================================================

var bool mss_bullish_ob_triggered = false
var float mss_bullish_ob_top = na
var float mss_bullish_ob_bottom = na

var bool mss_bearish_ob_triggered = false
var float mss_bearish_ob_top = na
var float mss_bearish_ob_bottom = na

if bullish_engulfing_in_demand and array.size(ltf_fh_prices) > 0
    for i = 0 to array.size(ltf_fh_prices) - 1
        if not array.get(ltf_fh_broken_flags, i)
            if close > array.get(ltf_fh_prices, i)
                array.set(ltf_fh_broken_flags, i, true)
                mss_bullish_ob_triggered := true
                mss_bullish_ob_top := bullish_ob_top
                mss_bullish_ob_bottom := bullish_ob_bottom
                break

if bearish_engulfing_in_supply and array.size(ltf_fl_prices) > 0
    for i = 0 to array.size(ltf_fl_prices) - 1
        if not array.get(ltf_fl_broken_flags, i)
            if close < array.get(ltf_fl_prices, i)
                array.set(ltf_fl_broken_flags, i, true)
                mss_bearish_ob_triggered := true
                mss_bearish_ob_top := bearish_ob_top
                mss_bearish_ob_bottom := bearish_ob_bottom
                break

plotshape(mss_bullish_ob_triggered, "MSS Bullish OB", shape.triangleup, location.belowbar, color.new(color.blue, 0), text="MSS", textcolor=color.white, size=size.normal)
plotshape(mss_bearish_ob_triggered, "MSS Bearish OB", shape.triangledown, location.abovebar, color.new(color.orange, 0), text="MSS", textcolor=color.white, size=size.normal)

// ============================================================================
// TRADE EXECUTION
// ============================================================================

// Long Entry
if mss_bullish_ob_triggered and not in_long_trade and not in_short_trade and not is_no_trade_time
    strategy.entry("Long", strategy.long, qty=1)
    in_long_trade := true
    long_entry_price := close

    float ob_range = mss_bullish_ob_top - mss_bullish_ob_bottom
    long_sl_price := mss_bullish_ob_bottom - (ob_range * 0.5)
    long_tp_price := long_entry_price + ((long_entry_price - long_sl_price) * tp_rr_ratio)

    long_tp_line := line.new(bar_index, long_tp_price, bar_index + 1, long_tp_price, color=color.new(color.green, 0), width=2, style=line.style_dashed)
    long_sl_line := line.new(bar_index, long_sl_price, bar_index + 1, long_sl_price, color=color.new(color.red, 0), width=2, style=line.style_dashed)

// Short Entry
if mss_bearish_ob_triggered and not in_long_trade and not in_short_trade and not is_no_trade_time
    strategy.entry("Short", strategy.short, qty=1)
    in_short_trade := true
    short_entry_price := close

    float ob_range = mss_bearish_ob_top - mss_bearish_ob_bottom
    short_sl_price := mss_bearish_ob_top + (ob_range * 0.5)
    short_tp_price := short_entry_price - ((short_sl_price - short_entry_price) * tp_rr_ratio)

    short_tp_line := line.new(bar_index, short_tp_price, bar_index + 1, short_tp_price, color=color.new(color.green, 0), width=2, style=line.style_dashed)
    short_sl_line := line.new(bar_index, short_sl_price, bar_index + 1, short_sl_price, color=color.new(color.red, 0), width=2, style=line.style_dashed)

// Extend TP/SL lines
if in_long_trade
    line.set_x2(long_tp_line, bar_index)
    line.set_x2(long_sl_line, bar_index)

if in_short_trade
    line.set_x2(short_tp_line, bar_index)
    line.set_x2(short_sl_line, bar_index)

// Long Exit
if in_long_trade
    if high >= long_tp_price
        strategy.close("Long", comment="TP")
        in_long_trade := false
        line.delete(long_tp_line)
        line.delete(long_sl_line)
    else if low <= long_sl_price
        strategy.close("Long", comment="SL")
        in_long_trade := false
        line.delete(long_tp_line)
        line.delete(long_sl_line)

// Short Exit
if in_short_trade
    if low <= short_tp_price
        strategy.close("Short", comment="TP")
        in_short_trade := false
        line.delete(short_tp_line)
        line.delete(short_sl_line)
    else if high >= short_sl_price
        strategy.close("Short", comment="SL")
        in_short_trade := false
        line.delete(short_tp_line)
        line.delete(short_sl_line)

// Close during no-trade time
if is_no_trade_time
    if in_long_trade
        strategy.close("Long", comment="No Trade Time")
        in_long_trade := false
        line.delete(long_tp_line)
        line.delete(long_sl_line)

    if in_short_trade
        strategy.close("Short", comment="No Trade Time")
        in_short_trade := false
        line.delete(short_tp_line)
        line.delete(short_sl_line)

// ============================================================================
// DEBUG TABLE
// ============================================================================

if show_debug_table
    var table debug_table = table.new(position.top_right, 2, 20, border_width=1)

    if barstate.islast
        int row = 0

        // Header
        table.cell(debug_table, 0, row, "Metric", bgcolor=color.new(color.black, 20), text_color=color.white)
        table.cell(debug_table, 1, row, "Value", bgcolor=color.new(color.black, 20), text_color=color.white)
        row := row + 1

        // Session Info
        table.cell(debug_table, 0, row, "Session", bgcolor=color.new(color.black, 50), text_color=color.white)
        string current_session = is_asian ? "Asian" : is_london ? "London" : is_ny ? "NY" : "Other"
        table.cell(debug_table, 1, row, current_session, bgcolor=color.new(color.black, 50), text_color=color.white)
        row := row + 1

        table.cell(debug_table, 0, row, "No Trade Time", bgcolor=color.new(color.black, 50), text_color=color.white)
        table.cell(debug_table, 1, row, is_no_trade_time ? "YES" : "NO", bgcolor=color.new(color.black, 50), text_color=is_no_trade_time ? color.red : color.green)
        row := row + 1

        // Session Highs (ordered by price, highest to lowest)
        table.cell(debug_table, 0, row, "SESSION HIGHS", bgcolor=color.new(color.blue, 70), text_color=color.white)
        table.cell(debug_table, 1, row, "", bgcolor=color.new(color.blue, 70), text_color=color.white)
        row := row + 1

        // Collect all highs with labels and status
        var array<float> high_prices = array.new<float>()
        var array<string> high_labels = array.new<string>()
        var array<bool> high_invalidated = array.new<bool>()

        array.clear(high_prices)
        array.clear(high_labels)
        array.clear(high_invalidated)

        if not na(prev_asian_high)
            array.push(high_prices, prev_asian_high)
            array.push(high_labels, "Asian High")
            array.push(high_invalidated, asian_high_invalidated)

        if not na(prev_london_high)
            array.push(high_prices, prev_london_high)
            array.push(high_labels, "London High")
            array.push(high_invalidated, london_high_invalidated)

        if not na(prev_ny_high)
            array.push(high_prices, prev_ny_high)
            array.push(high_labels, "NY High")
            array.push(high_invalidated, ny_high_invalidated)

        // Bubble sort - highest to lowest
        int high_size = array.size(high_prices)
        if high_size > 1
            for i = 0 to high_size - 2
                for j = 0 to high_size - 2 - i
                    if array.get(high_prices, j) < array.get(high_prices, j + 1)
                        // Swap prices
                        temp_price = array.get(high_prices, j)
                        array.set(high_prices, j, array.get(high_prices, j + 1))
                        array.set(high_prices, j + 1, temp_price)
                        // Swap labels
                        temp_label = array.get(high_labels, j)
                        array.set(high_labels, j, array.get(high_labels, j + 1))
                        array.set(high_labels, j + 1, temp_label)
                        // Swap invalidated
                        temp_inv = array.get(high_invalidated, j)
                        array.set(high_invalidated, j, array.get(high_invalidated, j + 1))
                        array.set(high_invalidated, j + 1, temp_inv)

        // Display highs
        for i = 0 to array.size(high_prices) - 1
            label_text = array.get(high_labels, i)
            is_inv = array.get(high_invalidated, i)
            if is_inv
                label_text := "X " + label_text

            table.cell(debug_table, 0, row, label_text, bgcolor=color.new(color.black, 50), text_color=is_inv ? color.gray : session_high_color)
            table.cell(debug_table, 1, row, str.tostring(array.get(high_prices, i), format.mintick), bgcolor=color.new(color.black, 50), text_color=is_inv ? color.gray : session_high_color)
            row := row + 1

        // Session Lows (ordered by price, highest to lowest)
        table.cell(debug_table, 0, row, "SESSION LOWS", bgcolor=color.new(color.green, 70), text_color=color.white)
        table.cell(debug_table, 1, row, "", bgcolor=color.new(color.green, 70), text_color=color.white)
        row := row + 1

        // Collect all lows with labels and status
        var array<float> low_prices = array.new<float>()
        var array<string> low_labels = array.new<string>()
        var array<bool> low_invalidated = array.new<bool>()

        array.clear(low_prices)
        array.clear(low_labels)
        array.clear(low_invalidated)

        if not na(prev_asian_low)
            array.push(low_prices, prev_asian_low)
            array.push(low_labels, "Asian Low")
            array.push(low_invalidated, asian_low_invalidated)

        if not na(prev_london_low)
            array.push(low_prices, prev_london_low)
            array.push(low_labels, "London Low")
            array.push(low_invalidated, london_low_invalidated)

        if not na(prev_ny_low)
            array.push(low_prices, prev_ny_low)
            array.push(low_labels, "NY Low")
            array.push(low_invalidated, ny_low_invalidated)

        // Bubble sort - highest to lowest (for consistency)
        int low_size = array.size(low_prices)
        if low_size > 1
            for i = 0 to low_size - 2
                for j = 0 to low_size - 2 - i
                    if array.get(low_prices, j) < array.get(low_prices, j + 1)
                        // Swap prices
                        temp_price = array.get(low_prices, j)
                        array.set(low_prices, j, array.get(low_prices, j + 1))
                        array.set(low_prices, j + 1, temp_price)
                        // Swap labels
                        temp_label = array.get(low_labels, j)
                        array.set(low_labels, j, array.get(low_labels, j + 1))
                        array.set(low_labels, j + 1, temp_label)
                        // Swap invalidated
                        temp_inv = array.get(low_invalidated, j)
                        array.set(low_invalidated, j, array.get(low_invalidated, j + 1))
                        array.set(low_invalidated, j + 1, temp_inv)

        // Display lows
        for i = 0 to array.size(low_prices) - 1
            label_text = array.get(low_labels, i)
            is_inv = array.get(low_invalidated, i)
            if is_inv
                label_text := "X " + label_text

            table.cell(debug_table, 0, row, label_text, bgcolor=color.new(color.black, 50), text_color=is_inv ? color.gray : session_low_color)
            table.cell(debug_table, 1, row, str.tostring(array.get(low_prices, i), format.mintick), bgcolor=color.new(color.black, 50), text_color=is_inv ? color.gray : session_low_color)
            row := row + 1

        // Zones
        table.cell(debug_table, 0, row, "Demand Zones", bgcolor=color.new(color.black, 50), text_color=color.white)
        table.cell(debug_table, 1, row, str.tostring(array.size(htf_demand_zones)), bgcolor=color.new(color.black, 50), text_color=color.green)
        row := row + 1

        table.cell(debug_table, 0, row, "Supply Zones", bgcolor=color.new(color.black, 50), text_color=color.white)
        table.cell(debug_table, 1, row, str.tostring(array.size(htf_supply_zones)), bgcolor=color.new(color.black, 50), text_color=color.red)
        row := row + 1

        // Trade Status
        table.cell(debug_table, 0, row, "In Long Trade", bgcolor=color.new(color.black, 50), text_color=color.white)
        table.cell(debug_table, 1, row, in_long_trade ? "YES" : "NO", bgcolor=color.new(color.black, 50), text_color=in_long_trade ? color.green : color.gray)
        row := row + 1

        table.cell(debug_table, 0, row, "In Short Trade", bgcolor=color.new(color.black, 50), text_color=color.white)
        table.cell(debug_table, 1, row, in_short_trade ? "YES" : "NO", bgcolor=color.new(color.black, 50), text_color=in_short_trade ? color.red : color.gray)
        row := row + 1

        if in_long_trade
            table.cell(debug_table, 0, row, "Long TP", bgcolor=color.new(color.black, 50), text_color=color.white)
            table.cell(debug_table, 1, row, str.tostring(long_tp_price, format.mintick), bgcolor=color.new(color.black, 50), text_color=color.green)
            row := row + 1

            table.cell(debug_table, 0, row, "Long SL", bgcolor=color.new(color.black, 50), text_color=color.white)
            table.cell(debug_table, 1, row, str.tostring(long_sl_price, format.mintick), bgcolor=color.new(color.black, 50), text_color=color.red)
            row := row + 1

        if in_short_trade
            table.cell(debug_table, 0, row, "Short TP", bgcolor=color.new(color.black, 50), text_color=color.white)
            table.cell(debug_table, 1, row, str.tostring(short_tp_price, format.mintick), bgcolor=color.new(color.black, 50), text_color=color.green)
            row := row + 1

            table.cell(debug_table, 0, row, "Short SL", bgcolor=color.new(color.black, 50), text_color=color.white)
            table.cell(debug_table, 1, row, str.tostring(short_sl_price, format.mintick), bgcolor=color.new(color.black, 50), text_color=color.red)
            row := row + 1
