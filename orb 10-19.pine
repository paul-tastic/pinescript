//@version=5
strategy("ORB + Fib", overlay=true, max_boxes_count=500, max_lines_count=500, max_labels_count=500)

// ============================================================================
// INPUTS
// ============================================================================
orb_minutes = input.int(30, "Opening Range Duration (minutes)", minval=5, maxval=60, step=5)
show_debug = input.bool(true, "Show Debug Table")
show_chart_levels = input.bool(false, "Show Chart Levels")

// Session Selection
use_ny_session = input.bool(true, "Trade NY Session (9:30 AM ET)", group="Trading Sessions")
use_asian_session = input.bool(false, "Trade Asian Session (6:00 PM ET / 8:00 AM Tokyo)", group="Trading Sessions")
use_london_session = input.bool(false, "Trade London Session (3:00 AM ET / 8:00 AM London)", group="Trading Sessions")

// Indicator Settings
rsi_length = input.int(14, "RSI Length", group="Indicators")
rsi_ob_level = input.int(65, "RSI Overbought", minval=50, maxval=90, group="Indicators")
rsi_os_level = input.int(35, "RSI Oversold", minval=10, maxval=50, group="Indicators")

stoch_k = input.int(14, "Stochastic K", group="Indicators")
stoch_d = input.int(3, "Stochastic D", group="Indicators")
stoch_smooth = input.int(3, "Stochastic Smooth", group="Indicators")
stoch_ob_level = input.int(70, "Stoch Overbought", minval=50, maxval=100, group="Indicators")
stoch_os_level = input.int(30, "Stoch Oversold", minval=0, maxval=50, group="Indicators")

// Entry Confirmation
entry_mode = input.string("Price Action Only", "Entry Signal Mode", 
              options=["RSI Only", "Stoch Only", "RSI or Stoch", "RSI and Stoch", "Price Action Only"], 
              group="Entry Rules", tooltip="Start with 'Price Action Only' to test zone detection")

// Entry Filters to reduce losing trades
use_rsi_filter = input.bool(false, "Use RSI Filter (Strict)", group="Entry Rules", tooltip="Only enter if RSI is extreme (>70 or <30)")
use_momentum_filter = input.bool(false, "Use Momentum Filter", group="Entry Rules", tooltip="Only enter if candle has strong momentum (30%+ of ATR)")
require_higher_low = input.bool(false, "Require Higher Low/Lower High", group="Entry Rules", tooltip="Stricter entry confirmation")
atr_period = input.int(14, "ATR Period", group="Entry Rules")

// Position Sizing
risk_amount = input.float(500, "Risk Per Trade ($)", minval=1, step=50, group="Risk Management")
use_position_sizing = input.bool(true, "Use Position Sizing", group="Risk Management")
risk_reward_ratio = input.float(2.0, "Risk:Reward Ratio", minval=0.5, maxval=10, step=0.5, group="Risk Management")

// Stop Loss Options
stop_type = input.string("Auto (Tightest)", "Stop Loss Type", 
              options=["Auto (Tightest)", "Swing Hi/Lo", "Opposite ORB", "Opposite ORB + 2 Tick"], 
              group="Risk Management")

// ============================================================================
// VARIABLES & ARRAYS
// ============================================================================
var float orb_high = na
var float orb_low = na
var bool orb_complete = false
var box orb_box = na
var string breakout_direction = na
var bool in_trade = false
var string setup_stage = "Waiting for ORB"
var bool trade_completed = false
var string current_session = na

var float fib_0 = na
var float fib_236 = na
var float fib_382 = na
var float fib_50 = na
var float fib_618 = na
var float fib_786 = na
var float fib_100 = na

var line fib_line_0 = na
var line fib_line_50 = na
var line fib_618_line = na
var line fib_786_line = na
var line fib_100_line = na
var box entry_zone_box = na

var line orb_high_line = na
var line orb_low_line = na
var int orb_start_bar = na

var line entry_line = na
var line stop_line = na
var line tp_line = na
var label trade_label = na

var float entry_price = na
var float stop_loss = na
var float take_profit = na
var float breakout_level = na
var float position_size = na

var int orb_start_time = na
var bool in_orb = false
var bool zone_visited = false

// ============================================================================
// TIME FUNCTIONS (MULTI-SESSION SUPPORT)
// ============================================================================

get_et_hour() =>
    hour(time, "America/New_York")

get_et_minute() =>
    minute(time, "America/New_York")

is_session_start() =>
    bool is_start = false
    string session_name = na
    current_hour = get_et_hour()
    current_minute = get_et_minute()
    prev_hour = get_et_hour()[1]
    prev_minute = get_et_minute()[1]
    
    if use_ny_session
        if current_hour == 9 and current_minute == 30 and not (prev_hour == 9 and prev_minute == 30)
            is_start := true
            session_name := "NY"
    
    if use_asian_session and not is_start
        if current_hour == 18 and current_minute == 0 and not (prev_hour == 18 and prev_minute == 0)
            is_start := true
            session_name := "Asian"
    
    if use_london_session and not is_start
        if current_hour == 3 and current_minute == 0 and not (prev_hour == 3 and prev_minute == 0)
            is_start := true
            session_name := "London"
    
    [is_start, session_name]

[session_started, session_name] = is_session_start()

if session_started
    orb_start_time := time
    in_orb := true
    current_session := session_name

is_in_orb_period() =>
    bool result = false
    if not na(orb_start_time) and in_orb
        time_diff = (time - orb_start_time) / 60000
        result := time_diff >= 0 and time_diff < orb_minutes
    result

if in_orb and not na(orb_start_time)
    time_diff = (time - orb_start_time) / 60000
    if time_diff >= orb_minutes
        in_orb := false

is_end_of_session() =>
    current_hour = get_et_hour()
    bool is_end = false
    
    if current_session == "NY"
        is_end := current_hour >= 16
    else if current_session == "Asian"
        is_end := current_hour >= 2 and current_hour < 3
    else if current_session == "London"
        is_end := current_hour >= 9 and current_hour < 10
    
    is_end

// ============================================================================
// INDICATOR CALCULATIONS
// ============================================================================

rsi = ta.rsi(close, rsi_length)
stoch_k_value = ta.stoch(close, high, low, stoch_k)
stoch_d_value = ta.sma(stoch_k_value, stoch_d)
atr_value = ta.atr(atr_period)

// ============================================================================
// REVERSAL DETECTION
// ============================================================================

detect_bullish_reversal() =>
    bool reversal = false
    bool rsi_signal = rsi < rsi_os_level or (rsi > rsi[1] and rsi < 50)
    bool stoch_signal = stoch_k_value < stoch_os_level or (stoch_k_value > stoch_d_value and stoch_k_value[1] <= stoch_d_value[1])
    bool bullish_candle = close > open
    
    if entry_mode == "RSI Only"
        reversal := rsi_signal and bullish_candle
    else if entry_mode == "Stoch Only"
        reversal := stoch_signal and bullish_candle
    else if entry_mode == "RSI or Stoch"
        reversal := (rsi_signal or stoch_signal) and bullish_candle
    else if entry_mode == "RSI and Stoch"
        reversal := rsi_signal and stoch_signal and bullish_candle
    else
        reversal := bullish_candle
    
    reversal

detect_bearish_reversal() =>
    bool reversal = false
    bool rsi_signal = rsi > rsi_ob_level or (rsi < rsi[1] and rsi > 50)
    bool stoch_signal = stoch_k_value > stoch_ob_level or (stoch_k_value < stoch_d_value and stoch_k_value[1] >= stoch_d_value[1])
    bool bearish_candle = close < open
    
    if entry_mode == "RSI Only"
        reversal := rsi_signal and bearish_candle
    else if entry_mode == "Stoch Only"
        reversal := stoch_signal and bearish_candle
    else if entry_mode == "RSI or Stoch"
        reversal := (rsi_signal or stoch_signal) and bearish_candle
    else if entry_mode == "RSI and Stoch"
        reversal := rsi_signal and stoch_signal and bearish_candle
    else
        reversal := bearish_candle
    
    reversal

bullish_reversal = detect_bullish_reversal()
bearish_reversal = detect_bearish_reversal()

// ============================================================================
// ORB LOGIC
// ============================================================================
if session_started
    orb_high := na
    orb_low := na
    orb_complete := false
    breakout_direction := na
    in_trade := false
    trade_completed := false
    zone_visited := false
    setup_stage := "Building ORB - " + current_session + " Session"
    
    if not na(orb_box)
        box.delete(orb_box)
    if not na(fib_line_0)
        line.delete(fib_line_0)
        line.delete(fib_line_50)
        line.delete(fib_618_line)
        line.delete(fib_786_line)
        line.delete(fib_100_line)
    if not na(entry_zone_box)
        box.delete(entry_zone_box)
    if not na(orb_high_line)
        line.delete(orb_high_line)
        line.delete(orb_low_line)
    if not na(entry_line)
        line.delete(entry_line)
        line.delete(stop_line)
        line.delete(tp_line)
        label.delete(trade_label)

if is_in_orb_period()
    if na(orb_high) or high > orb_high
        orb_high := high
    if na(orb_low) or low < orb_low
        orb_low := low
    
    if na(orb_box)
        orb_box := box.new(orb_start_time, orb_high, time, orb_low, 
                          xloc=xloc.bar_time,
                          border_color=color.blue, bgcolor=color.new(color.blue, 90),
                          border_width=2)
        orb_start_bar := bar_index
    else
        box.set_top(orb_box, orb_high)
        box.set_bottom(orb_box, orb_low)
        box.set_right(orb_box, time)
    
    time_elapsed = math.round((time - orb_start_time) / 60000)
    setup_stage := "Building ORB - " + current_session + " (" + str.tostring(time_elapsed) + "/" + str.tostring(orb_minutes) + " min)"

if not is_in_orb_period() and not orb_complete and not na(orb_high) and not na(orb_low) and not na(orb_start_time)
    orb_complete := true
    setup_stage := "ORB Complete - " + current_session + " - Waiting for Breakout"
    
    if not na(orb_box)
        box.set_bgcolor(orb_box, color.new(color.blue, 95))
    
    if na(orb_high_line)
        orb_high_line := line.new(time, orb_high, time, orb_high, 
                                  xloc=xloc.bar_time, extend=extend.right,
                                  color=color.blue, width=2, style=line.style_dashed)
        orb_low_line := line.new(time, orb_low, time, orb_low,
                                 xloc=xloc.bar_time, extend=extend.right,
                                 color=color.blue, width=2, style=line.style_dashed)

if not na(orb_high_line) and orb_complete
    if is_end_of_session()
        line.set_x2(orb_high_line, time)
        line.set_y2(orb_high_line, orb_high)
        line.set_x2(orb_low_line, time)
        line.set_y2(orb_low_line, orb_low)
        line.set_extend(orb_high_line, extend.none)
        line.set_extend(orb_low_line, extend.none)

// ============================================================================
// BREAKOUT DETECTION
// ============================================================================
if orb_complete and na(breakout_direction) and not in_trade
    if close > orb_high
        breakout_direction := "bullish"
        breakout_level := orb_high
        zone_visited := false
        setup_stage := "Bullish Breakout - Drawing Fibs"
        
        fib_0 := high
        fib_100 := orb_low
        float fib_range = fib_0 - fib_100
        fib_236 := fib_0 - (fib_range * 0.236)
        fib_382 := fib_0 - (fib_range * 0.382)
        fib_50 := fib_0 - (fib_range * 0.50)
        fib_618 := fib_0 - (fib_range * 0.618)
        fib_786 := fib_0 - (fib_range * 0.786)
        
        fib_line_0 := line.new(time, fib_0, time, fib_0, 
                              xloc=xloc.bar_time, extend=extend.right, 
                              color=color.red, width=1, style=line.style_dotted)
        fib_line_50 := line.new(time, fib_50, time, fib_50, 
                               xloc=xloc.bar_time, extend=extend.right, 
                               color=color.yellow, width=2, style=line.style_solid)
        fib_618_line := line.new(time, fib_618, time, fib_618, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.yellow, width=2, style=line.style_solid)
        fib_786_line := line.new(time, fib_786, time, fib_786, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.purple, width=1, style=line.style_dotted)
        fib_100_line := line.new(time, fib_100, time, fib_100, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.green, width=1, style=line.style_dotted)
        
        entry_zone_box := box.new(time, fib_50, time, fib_100,
                                  xloc=xloc.bar_time, extend=extend.right,
                                  border_color=color.yellow, bgcolor=color.new(color.yellow, 90),
                                  border_width=1)
    
    else if close < orb_low
        breakout_direction := "bearish"
        breakout_level := orb_low
        zone_visited := false
        setup_stage := "Bearish Breakout - Drawing Fibs"
        
        fib_0 := low
        fib_100 := orb_high
        float fib_range = fib_100 - fib_0
        fib_236 := fib_0 + (fib_range * 0.236)
        fib_382 := fib_0 + (fib_range * 0.382)
        fib_50 := fib_0 + (fib_range * 0.50)
        fib_618 := fib_0 + (fib_range * 0.618)
        fib_786 := fib_0 + (fib_range * 0.786)
        
        fib_line_0 := line.new(time, fib_0, time, fib_0, 
                              xloc=xloc.bar_time, extend=extend.right, 
                              color=color.red, width=1, style=line.style_dotted)
        fib_line_50 := line.new(time, fib_50, time, fib_50, 
                               xloc=xloc.bar_time, extend=extend.right, 
                               color=color.yellow, width=2, style=line.style_solid)
        fib_618_line := line.new(time, fib_618, time, fib_618, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.yellow, width=2, style=line.style_solid)
        fib_786_line := line.new(time, fib_786, time, fib_786, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.purple, width=1, style=line.style_dotted)
        fib_100_line := line.new(time, fib_100, time, fib_100, 
                                 xloc=xloc.bar_time, extend=extend.right, 
                                 color=color.green, width=1, style=line.style_dotted)
        
        entry_zone_box := box.new(time, fib_100, time, fib_50,
                                  xloc=xloc.bar_time, extend=extend.right,
                                  border_color=color.yellow, bgcolor=color.new(color.yellow, 90),
                                  border_width=1)

// ============================================================================
// ENTRY ZONE CHECK
// ============================================================================
in_entry_zone = false

if breakout_direction == "bullish" and not na(fib_50) and not na(fib_618) and not na(fib_100)
    in_entry_zone := low <= fib_50 and high >= fib_618
    if in_entry_zone
        zone_visited := true
        setup_stage := "In Entry Zone (50-61.8%+) - Waiting for Reversal"
        
else if breakout_direction == "bearish" and not na(fib_50) and not na(fib_618) and not na(fib_100)
    in_entry_zone := high >= fib_50 and low <= fib_618
    if in_entry_zone
        zone_visited := true
        setup_stage := "In Entry Zone (50-61.8%+) - Waiting for Reversal"

// ============================================================================
// STOP LOSS CALCULATION
// ============================================================================
calculate_stop_loss(direction) =>
    float stop = na
    swing_lookback = 10
    tick_size = syminfo.mintick
    two_tick_buffer = tick_size * 2
    
    if direction == "bullish"
        swing_low = ta.lowest(low, swing_lookback)
        
        if stop_type == "Swing Hi/Lo"
            stop := swing_low
        else if stop_type == "Opposite ORB"
            stop := orb_low
        else if stop_type == "Opposite ORB + 2 Tick"
            stop := orb_low - two_tick_buffer
        else
            stop := math.max(math.max(swing_low, orb_low), orb_low - two_tick_buffer)
    else
        swing_high = ta.highest(high, swing_lookback)
        
        if stop_type == "Swing Hi/Lo"
            stop := swing_high
        else if stop_type == "Opposite ORB"
            stop := orb_high
        else if stop_type == "Opposite ORB + 2 Tick"
            stop := orb_high + two_tick_buffer
        else
            stop := math.min(math.min(swing_high, orb_high), orb_high + two_tick_buffer)
    
    stop

// ============================================================================
// POSITION SIZING
// ============================================================================
calculate_position_size(entry, stop) =>
    float qty = 1.0
    if use_position_sizing
        risk_per_point = math.abs(entry - stop)
        if risk_per_point > 0
            qty := risk_amount / (risk_per_point * syminfo.pointvalue)
            qty := math.max(1, math.round(qty))
    qty

// ============================================================================
// ENTRY FILTERS
// ============================================================================
passes_rsi_filter = not use_rsi_filter or rsi > rsi_ob_level or rsi < rsi_os_level
passes_momentum_filter = not use_momentum_filter or (math.abs(close - open) > (atr_value * 0.3))
check_higher_low = not require_higher_low or (breakout_direction == "bullish" and low > low[1]) or (breakout_direction == "bearish" and high < high[1])

// ============================================================================
// ENTRY LOGIC - STRICT ZONE ENFORCEMENT
// ============================================================================
// Double-check we're still in the zone at entry time
still_in_zone = false
if breakout_direction == "bullish" and not na(fib_50) and not na(fib_618) and not na(fib_100)
    still_in_zone := close <= fib_50 and close >= fib_618
else if breakout_direction == "bearish" and not na(fib_50) and not na(fib_618) and not na(fib_100)
    still_in_zone := close >= fib_50 and close <= fib_618

if in_entry_zone and not in_trade and zone_visited and still_in_zone
    if breakout_direction == "bullish" and bullish_reversal and passes_rsi_filter and passes_momentum_filter and check_higher_low
        entry_price := close
        stop_loss := calculate_stop_loss("bullish")
        // Calculate TP based on R:R ratio
        take_profit := entry_price + ((entry_price - stop_loss) * risk_reward_ratio)
        position_size := calculate_position_size(entry_price, stop_loss)
        
        strategy.entry("Long", strategy.long, qty=position_size)
        in_trade := true
        setup_stage := "LONG TRADE ACTIVE"
        
        entry_line := line.new(time, entry_price, time, entry_price, 
                              xloc=xloc.bar_time, extend=extend.right,
                              color=color.white, width=2, style=line.style_dashed)
        stop_line := line.new(time, stop_loss, time, stop_loss,
                             xloc=xloc.bar_time, extend=extend.right,
                             color=color.red, width=2, style=line.style_solid)
        tp_line := line.new(time, take_profit, time, take_profit,
                           xloc=xloc.bar_time, extend=extend.right,
                           color=color.green, width=2, style=line.style_solid)
        
        trade_info = "LONG ENTRY\n" + 
                     "Qty: " + str.tostring(position_size, "#") + " contracts\n" +
                     "Entry: " + str.tostring(entry_price, "#.##") + "\n" +
                     "Stop: " + str.tostring(stop_loss, "#.##") + "\n" +
                     "Target: " + str.tostring(take_profit, "#.##") + "\n" +
                     "Risk: $" + str.tostring(risk_amount, "#") + "\n" +
                     "R:R = 1:" + str.tostring((take_profit - entry_price) / (entry_price - stop_loss), "#.##")
        
        trade_label := label.new(time, low - (atr_value * 2), trade_info,
                                 xloc=xloc.bar_time, style=label.style_label_center,
                                 color=color.new(color.green, 20), textcolor=color.white, 
                                 size=size.small)
    
    else if breakout_direction == "bearish" and bearish_reversal and passes_rsi_filter and passes_momentum_filter and check_higher_low and still_in_zone
        entry_price := close
        stop_loss := calculate_stop_loss("bearish")
        // Calculate TP based on R:R ratio
        take_profit := entry_price - ((stop_loss - entry_price) * risk_reward_ratio)
        position_size := calculate_position_size(entry_price, stop_loss)
        
        strategy.entry("Short", strategy.short, qty=position_size)
        in_trade := true
        setup_stage := "SHORT TRADE ACTIVE"
        
        entry_line := line.new(time, entry_price, time, entry_price,
                              xloc=xloc.bar_time, extend=extend.right,
                              color=color.white, width=2, style=line.style_dashed)
        stop_line := line.new(time, stop_loss, time, stop_loss,
                             xloc=xloc.bar_time, extend=extend.right,
                             color=color.red, width=2, style=line.style_solid)
        tp_line := line.new(time, take_profit, time, take_profit,
                           xloc=xloc.bar_time, extend=extend.right,
                           color=color.green, width=2, style=line.style_solid)
        
        trade_info = "SHORT ENTRY\n" + 
                     "Qty: " + str.tostring(position_size, "#") + " contracts\n" +
                     "Entry: " + str.tostring(entry_price, "#.##") + "\n" +
                     "Stop: " + str.tostring(stop_loss, "#.##") + "\n" +
                     "Target: " + str.tostring(take_profit, "#.##") + "\n" +
                     "Risk: $" + str.tostring(risk_amount, "#") + "\n" +
                     "R:R = 1:" + str.tostring((entry_price - take_profit) / (stop_loss - entry_price), "#.##")
        
        trade_label := label.new(time, entry_price - (atr_value * 2), trade_info,
                                 xloc=xloc.bar_time, style=label.style_label_center,
                                 color=color.new(color.red, 20), textcolor=color.white, 
                                 size=size.small)

// ============================================================================
// EXIT LOGIC
// ============================================================================
if in_trade and not na(stop_loss) and not na(take_profit)
    if breakout_direction == "bullish"
        strategy.exit("Exit Long", "Long", stop=stop_loss, limit=take_profit)
        if strategy.position_size == 0 and strategy.position_size[1] > 0
            trade_completed := true
            setup_stage := "Trade Completed - Long Closed"
            if not na(entry_line)
                line.set_extend(entry_line, extend.none)
                line.set_extend(stop_line, extend.none)
                line.set_extend(tp_line, extend.none)
    else if breakout_direction == "bearish"
        strategy.exit("Exit Short", "Short", stop=stop_loss, limit=take_profit)
        if strategy.position_size == 0 and strategy.position_size[1] < 0
            trade_completed := true
            setup_stage := "Trade Completed - Short Closed"
            if not na(entry_line)
                line.set_extend(entry_line, extend.none)
                line.set_extend(stop_line, extend.none)
                line.set_extend(tp_line, extend.none)

// ============================================================================
// DEBUG TABLE
// ============================================================================
if show_debug
    var table debug_table = table.new(position.top_right, 2, 20, border_width=1, 
                                      bgcolor=color.new(color.black, 20), 
                                      frame_color=color.new(color.gray, 50), 
                                      frame_width=2)
    
    table.cell(debug_table, 0, 0, "Parameter", bgcolor=color.new(color.black, 30), 
              text_color=color.white, text_size=size.small)
    table.cell(debug_table, 1, 0, "Value", bgcolor=color.new(color.black, 30), 
              text_color=color.white, text_size=size.small)
    
    table.cell(debug_table, 0, 1, "Session", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 1, na(current_session) ? "N/A" : current_session, text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 2, "Setup Stage", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 2, setup_stage, text_size=size.small, text_color=color.white, bgcolor=in_trade ? color.new(color.green, 60) : trade_completed ? color.new(color.gray, 60) : color.new(color.black, 40))
    
    table.cell(debug_table, 0, 3, "Current Close", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 3, str.tostring(close, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 4, "In Entry Zone", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 4, in_entry_zone ? "YES" : "NO", text_size=size.small, text_color=color.white, bgcolor=in_entry_zone ? color.new(color.yellow, 60) : color.new(color.black, 40))
    
    table.cell(debug_table, 0, 5, "ORB High", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 5, na(orb_high) ? "N/A" : str.tostring(orb_high, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 6, "ORB Low", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 6, na(orb_low) ? "N/A" : str.tostring(orb_low, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 7, "Breakout Dir", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 7, na(breakout_direction) ? "N/A" : breakout_direction, text_size=size.small, text_color=color.white, bgcolor=breakout_direction == "bullish" ? color.new(color.green, 60) : breakout_direction == "bearish" ? color.new(color.red, 60) : color.new(color.black, 40))
    
    table.cell(debug_table, 0, 8, "Fib 0% (Break)", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 8, na(fib_0) ? "N/A" : str.tostring(fib_0, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 9, "Fib 50%", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 9, na(fib_50) ? "N/A" : str.tostring(fib_50, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 10, "Fib 61.8%", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 10, na(fib_618) ? "N/A" : str.tostring(fib_618, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 11, "RSI", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 11, str.tostring(rsi, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 12, "Stoch K", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 12, str.tostring(stoch_k_value, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 13, "Stoch D", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 13, str.tostring(stoch_d_value, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 14, "Reversal Signal", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    reversal_text = bullish_reversal ? "Bullish" : bearish_reversal ? "Bearish" : "None"
    table.cell(debug_table, 1, 14, reversal_text, text_size=size.small, text_color=color.white, bgcolor=bullish_reversal ? color.new(color.green, 60) : bearish_reversal ? color.new(color.red, 60) : color.new(color.black, 40))
    
    table.cell(debug_table, 0, 15, "Position Size", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 15, na(position_size) ? "N/A" : str.tostring(position_size, "#") + " contracts", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 16, "Entry Price", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 16, na(entry_price) ? "N/A" : str.tostring(entry_price, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 17, "Stop Loss", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 17, na(stop_loss) ? "N/A" : str.tostring(stop_loss, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 18, "Take Profit", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    table.cell(debug_table, 1, 18, na(take_profit) ? "N/A" : str.tostring(take_profit, "#.##"), text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    
    table.cell(debug_table, 0, 19, "Filters Pass", text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))
    filter_status = (passes_rsi_filter ? "RSI✓ " : "RSI✗ ") + (passes_momentum_filter ? "Mom✓ " : "Mom✗ ") + (check_higher_low ? "HL✓" : "HL✗")
    table.cell(debug_table, 1, 19, filter_status, text_size=size.small, text_color=color.white, bgcolor=color.new(color.black, 40))

// ============================================================================
// PLOT INDICATORS (SEPARATE PANE)
// ============================================================================
plot(rsi, "RSI", color=color.blue)
hline(rsi_ob_level, "RSI OB", color=color.red, linestyle=hline.style_dashed)
hline(rsi_os_level, "RSI OS", color=color.green, linestyle=hline.style_dashed)
hline(50, "RSI Mid", color=color.gray, linestyle=hline.style_dotted)

plot(stoch_k_value, "Stoch K", color=color.orange)
plot(stoch_d_value, "Stoch D", color=color.purple)
hline(stoch_ob_level, "Stoch OB", color=color.red, linestyle=hline.style_dashed)
hline(stoch_os_level, "Stoch OS", color=color.green, linestyle=hline.style_dashed)