//@version=5
strategy("Mach2FX GC Hugger + TEMA + Trail", 
     overlay=true, pyramiding=1, initial_capital=150000, 
     commission_type=strategy.commission.cash_per_contract, commission_value=2)

// === USER INPUTS ===
higher_tf         = input.timeframe("60", "Higher timeframe (trend)")
ema_htf_len       = input.int(89, "HTF EMA length", minval=5)
ema_len           = input.int(21, "Entry EMA length", minval=2)
rsi_len           = input.int(14, "RSI length", minval=2)
rsi_filter        = input.int(50, "RSI threshold")
atr_len           = input.int(14, "ATR length", minval=1)
atr_stop_mult     = input.float(2.0, "Stop = ATR ×", step=0.1)
atr_target_mult   = input.float(3.0, "Target = ATR ×", step=0.1)
use_trailing      = input.bool(true, "Use trailing stop?")
trail_offset_mult = input.float(1.0, "Trail offset (ATR ×)", step=0.1)
volThreshold      = input.float(0.5, "Volume threshold (× SMA)", step=0.1, minval=0.0)
riskPerTrade      = input.float(1500.0, "Fixed $ Risk per Trade", step=50)
max_positions     = input.int(1, "Max concurrent positions", minval=1)
onlyWithHTF       = input.bool(true, "Only take trades in direction of HTF trend?")

// === SESSION INPUTS (New York time) ===
tradeSession = input.session("0930-1600", "Trading Hours (entries allowed)")
closeHour    = input.int(15, "Close Trades Hour (NY Time)", minval=0, maxval=23)
closeMinute  = input.int(45, "Close Trades Minute (NY Time)", minval=0, maxval=59)

// === INDICATOR TOGGLES ===
showEMA_HTF   = input.bool(true, "Show HTF EMA?")
showTEMA_HTF  = input.bool(true, "Show HTF TEMA?")
showEMA_Entry = input.bool(true, "Show Entry EMA?")
showRSI       = input.bool(false, "Show RSI?")
showATR       = input.bool(false, "Show ATR?")
showVolume    = input.bool(false, "Show Volume SMA?")

// === INDICATORS ===
emaHTF   = request.security(syminfo.tickerid, higher_tf, ta.ema(close, ema_htf_len))
ema      = ta.ema(close, ema_len)
rsi      = ta.rsi(close, rsi_len)
atr      = ta.atr(atr_len)
vol_sma  = ta.sma(volume, 20)

ema1     = request.security(syminfo.tickerid, "60", ta.ema(close, 9))
ema2     = request.security(syminfo.tickerid, "60", ta.ema(ema1, 9))
ema3     = request.security(syminfo.tickerid, "60", ta.ema(ema2, 9))
temaHTF  = (3*ema1) - (3*ema2) + ema3

ltf_ema1 = ta.ema(close, 9)
ltf_ema2 = ta.ema(ltf_ema1, 9)
ltf_ema3 = ta.ema(ltf_ema2, 9)
temaLTF  = (3*ema1) - (3*ema2) + ema3

// === TREND FILTERS ===
trendBull = close > emaHTF
trendBear = close < emaHTF
biasLong  = trendBull ? 1.0 : 0.5
biasShort = trendBear ? 1.0 : 0.5

// === ENTRY CONDITIONS ===
longCondition  = ta.crossover(close, ema) and rsi > rsi_filter and volume > vol_sma * volThreshold
shortCondition = ta.crossunder(close, ema) and rsi < (100 - rsi_filter) and volume > vol_sma * volThreshold

longCondition  := longCondition and temaHTF > emaHTF
shortCondition := shortCondition and temaHTF < emaHTF

rsiHTF = request.security(syminfo.tickerid, higher_tf, ta.rsi(close, rsi_len))
longCondition  := longCondition and rsiHTF > 50 and atr > ta.sma(atr, 20)
shortCondition := shortCondition and rsiHTF < 50 and atr > ta.sma(atr, 20)

// === TRADING HOURS FILTER ===
inTradeSession = not na(time(timeframe.period, tradeSession, "America/New_York"))
longCondition  := longCondition  and inTradeSession and (not onlyWithHTF or trendBull)
shortCondition := shortCondition and inTradeSession and (not onlyWithHTF or trendBear)

// === LIMIT ENTRY PRICES ===
longLimitPrice  = ta.valuewhen(longCondition, high, 0)
shortLimitPrice = ta.valuewhen(shortCondition, low, 0)

// === CALCULATE CONTRACTS BASED ON $ RISK ===
calcQty(_stopDist) =>
    qty = math.floor(riskPerTrade / _stopDist)
    qty > 0 ? qty : na

// === TRADE VARIABLES (declare globally) ===
var float entryPriceTracked = na
var float stopPriceTracked  = na
var float takePriceTracked  = na
var float stopPrice         = na  // <- added
var float takePrice         = na  // <- added
var string directionTracked = ""


// === DRAW TRADE LINES ===
drawTradeLines(_entry, _stop, _target, _isLong) =>
    if _isLong
        line.new(bar_index, _entry, bar_index+1, _entry, color=color.green, width=2)
        line.new(bar_index, _stop,  bar_index+1, _stop,  color=color.red,   width=2, style=line.style_dashed)
        if not use_trailing
            line.new(bar_index, _target, bar_index+1, _target, color=color.blue, style=line.style_dashed)
    else
        line.new(bar_index, _entry, bar_index+1, _entry, color=color.red,   width=2)
        line.new(bar_index, _stop,  bar_index+1, _stop,  color=color.green, width=2, style=line.style_dashed)
        if not use_trailing
            line.new(bar_index, _target, bar_index+1, _target, color=color.blue, style=line.style_dashed)

// === ENTRIES & EXITS ===
if (longCondition and strategy.opentrades < max_positions)
    stopPrice = longLimitPrice - atr * atr_stop_mult
    takePrice = longLimitPrice + atr * atr_target_mult
    stopDist  = longLimitPrice - stopPrice
    qty       = calcQty(stopDist) * biasLong
    if not na(qty)
        strategy.entry("Long", strategy.long, qty=qty, limit=longLimitPrice)
        if use_trailing
            trailOffset = atr * trail_offset_mult
            strategy.exit("Exit Long", from_entry="Long", trail_points=trailOffset, trail_offset=trailOffset)
        else
            strategy.exit("Exit Long", from_entry="Long", stop=stopPrice, limit=takePrice)
        entryPriceTracked := longLimitPrice
        directionTracked  := "LONG"

if (shortCondition and strategy.opentrades < max_positions)
    stopPrice = shortLimitPrice + atr * atr_stop_mult
    takePrice = shortLimitPrice - atr * atr_target_mult
    stopDist  = stopPrice - shortLimitPrice
    qty       = calcQty(stopDist) * biasShort
    if not na(qty)
        strategy.entry("Short", strategy.short, qty=qty, limit=shortLimitPrice)
        if use_trailing
            trailOffset = atr * trail_offset_mult
            strategy.exit("Exit Short", from_entry="Short", trail_points=trailOffset, trail_offset=trailOffset)
        else
            strategy.exit("Exit Short", from_entry="Short", stop=stopPrice, limit=takePrice)
        entryPriceTracked := shortLimitPrice
        directionTracked  := "SHORT"

// Draw trade lines
if strategy.position_size != 0
    entryPriceTracked := strategy.position_avg_price
    drawTradeLines(entryPriceTracked, stopPrice, takePrice, strategy.position_size > 0)

// === CLOSE ALL OPEN TRADES AT SPECIFIC NY TIME ===
var bool closedThisSession = false
barTimeNY = time(timeframe.period)
barHour   = hour(barTimeNY)
barMinute = minute(barTimeNY)
isCloseSessionBar = (barHour == closeHour) and (barMinute == closeMinute)
if isCloseSessionBar and strategy.opentrades != 0
    strategy.close_all(comment="Session Close", immediately=true)
    closedThisSession := true
if not isCloseSessionBar
    closedThisSession := false

// === FIXED TABLE WITH HTF TIMEFRAME, TREND, OPEN PnL, EQUITY ===
var statsTable = table.new(position.bottom_left, 2, 10, border_width=1)

updateTable() =>
    table.cell(statsTable, 0, 0, "HTF Timeframe", bgcolor=color.gray, text_color=color.white)
    table.cell(statsTable, 1, 0, higher_tf, bgcolor=color.gray, text_color=color.yellow)
    table.cell(statsTable, 0, 1, "HTF Trend")
    table.cell(statsTable, 1, 1, trendBull ? "Bullish" : "Bearish", text_color= trendBull ? color.green : color.red)
    table.cell(statsTable, 0, 2, "HTF Filter Active")
    table.cell(statsTable, 1, 2, onlyWithHTF ? "Yes" : "No", text_color=onlyWithHTF ? color.green : color.red)
    table.cell(statsTable, 0, 3, "Entry")
    table.cell(statsTable, 1, 3, na(entryPriceTracked) ? "-" : str.tostring(entryPriceTracked, "#.##"))
    table.cell(statsTable, 0, 4, "Stop")
    table.cell(statsTable, 1, 4, na(stopPrice) ? "-" : str.tostring(stopPrice, "#.##"))
    table.cell(statsTable, 0, 5, "Target")
    table.cell(statsTable, 1, 5, use_trailing ? "Trailing" : str.tostring(takePrice, "#.##"))
    table.cell(statsTable, 0, 6, "Direction")
    table.cell(statsTable, 1, 6, directionTracked)
    table.cell(statsTable, 0, 7, "Open PnL")
    openPnL = strategy.opentrades > 0 ? strategy.opentrades.profit(strategy.opentrades - 1) : 0
    table.cell(statsTable, 1, 7, "$" + str.tostring(openPnL, "#,###.##"), text_color=openPnL >= 0 ? color.green : color.red)
    table.cell(statsTable, 0, 8, "Equity")
    table.cell(statsTable, 1, 8, "$" + str.tostring(strategy.equity, "#,###.##"), text_color=color.rgb(88, 59, 255))
    table.cell(statsTable, 0, 9, "RSI")
    table.cell(statsTable, 1, 9, str.tostring(rsi, '#.##'))

updateTable()

// === VISUALS ===
plot(showEMA_HTF   ? emaHTF   : na, title="HTF EMA", linewidth=2, color=color.orange)
plot(showTEMA_HTF  ? temaHTF  : na, title="HTF TEMA", linewidth=2, color=color.black)
plot(showEMA_Entry ? ema      : na, title="Entry EMA", linewidth=1, color=color.blue)
plot(showRSI       ? rsi      : na, title="RSI", color=color.orange)
plot(showATR       ? atr      : na, title="ATR", color=color.purple)
plot(showVolume    ? vol_sma  : na, title="Volume SMA", color=color.teal)
plotchar(longCondition,  title="Long Signal",  char="▲", location=location.belowbar, color=color.green)
plotchar(shortCondition, title="Short Signal", char="▼", location=location.abovebar, color=color.red)
