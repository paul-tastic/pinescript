//@version=5
strategy("EMA21 x SMA50 â€” Improved", overlay=true,
     default_qty_type=strategy.fixed, default_qty_value=3, pyramiding=1)

// === INPUTS ===
higher_tf = input.timeframe("60", "Higher timeframe (trend)")
require_htf_align = input.bool(true, "Require HTF alignment")
ema_len = input.int(21, "EMA length", minval=1)
sma_len = input.int(50, "SMA length", minval=1)

pivot_left  = input.int(5, "Pivot left bars", minval=1)
pivot_right = input.int(5, "Pivot right bars", minval=1)
fallback_lookback = input.int(50, "Fallback lookback", minval=1)

stop_mode  = input.string("Swing", "Stop mode", options=["Swing", "ATR"])
exit_mode  = input.string("FixedRR", "Exit mode", options=["FixedRR", "ATRTrail", "Hybrid"])
rr_ratio   = input.float(2.0, "Reward:Risk", step=0.1)

atr_len    = input.int(14, "ATR length", minval=1)
atr_mult   = input.float(2.0, "ATR multiplier", step=0.1)

cross_confirm_bars = input.int(3, "Cross confirmation bars", minval=1)

// Entry window inputs
entry_start_hour = input.int(9, "Entry Start Hour", minval=0, maxval=23)
entry_start_min  = input.int(30, "Entry Start Minute", minval=0, maxval=59)
entry_end_hour   = input.int(16, "Entry End Hour", minval=0, maxval=23)
entry_end_min    = input.int(0, "Entry End Minute", minval=0, maxval=59)

// === INDICATORS ===
ema_chart = ta.ema(close, ema_len)
sma_chart = ta.sma(close, sma_len)
[htf_ema, htf_sma] = request.security(syminfo.tickerid, higher_tf, [ta.ema(close, ema_len), ta.sma(close, sma_len)], lookahead=barmerge.lookahead_off)
htf_bull = htf_ema > htf_sma
htf_bear = htf_ema < htf_sma

// === ENTRY WINDOW ===
entry_start_time = timestamp("America/New_York", year, month, dayofmonth, entry_start_hour, entry_start_min)
entry_end_time   = timestamp("America/New_York", year, month, dayofmonth, entry_end_hour, entry_end_min)
in_entry_window = (time >= entry_start_time) and (time <= entry_end_time)
barTimeNY = time(timeframe.period)
barHour   = hour(barTimeNY)
barMinute = minute(barTimeNY)

// === CROSS CONFIRMATION ===
var int last_long_cross_bar = na
var int last_short_cross_bar = na

if ta.crossover(ema_chart, sma_chart)
    last_long_cross_bar := bar_index
if ta.crossunder(ema_chart, sma_chart)
    last_short_cross_bar := bar_index

long_allowed  = not na(last_long_cross_bar) and strategy.position_size == 0 and bar_index <= last_long_cross_bar + cross_confirm_bars
short_allowed = not na(last_short_cross_bar) and strategy.position_size == 0 and bar_index <= last_short_cross_bar + cross_confirm_bars

avoidOpen = (barHour == 16 and barMinute > 45) or (barHour == 17 and barMinute < 10)
long_allowed  := long_allowed and not avoidOpen
short_allowed := short_allowed and not avoidOpen

// === PREVIOUS CANDLE FILTER ===
prev_bull = close[1] > open[1]
prev_bear = close[1] < open[1]

trade_long  = long_allowed  and in_entry_window and (require_htf_align ? htf_bull : true) and prev_bull
trade_short = short_allowed and in_entry_window and (require_htf_align ? htf_bear : true) and prev_bear

// === SWING HIGH/LOW detection ===
pl = ta.pivotlow(low, pivot_left, pivot_right)
ph = ta.pivothigh(high, pivot_left, pivot_right)
var float last_pivot_low = na
var float last_pivot_high = na
if not na(pl)
    last_pivot_low := pl
if not na(ph)
    last_pivot_high := ph

// fallback stops
fallback_low  = ta.lowest(low, fallback_lookback)
fallback_high = ta.highest(high, fallback_lookback)

// ATR stop
atr = ta.atr(atr_len)
atr_stop_long  = close - atr * atr_mult
atr_stop_short = close + atr * atr_mult

// Final stop selection
long_stop_price  = stop_mode == "Swing" ? (na(last_pivot_low)  ? fallback_low  : last_pivot_low)  : atr_stop_long
short_stop_price = stop_mode == "Swing" ? (na(last_pivot_high) ? fallback_high : last_pivot_high) : atr_stop_short

// === ENTRY ===
if trade_long
    strategy.entry("Long", strategy.long)
if trade_short
    strategy.entry("Short", strategy.short)

// === EXIT MANAGEMENT ===
if strategy.position_size > 0
    entry_price = strategy.position_avg_price
    stop_price  = long_stop_price
    risk = entry_price - stop_price
    tp_price = entry_price + risk * rr_ratio

    if exit_mode == "FixedRR"
        strategy.exit("Exit Long", from_entry="Long", stop=stop_price, limit=tp_price)
    else if exit_mode == "ATRTrail"
        strategy.exit("Exit Long", from_entry="Long", stop=stop_price, trail_offset=atr * atr_mult)
    else if exit_mode == "Hybrid"
        strategy.exit("TP1", from_entry="Long", stop=stop_price, limit=tp_price, qty_percent=50)
        strategy.exit("Trail Long", from_entry="Long", stop=stop_price, trail_offset=atr * atr_mult, qty_percent=50)

if strategy.position_size < 0
    entry_price = strategy.position_avg_price
    stop_price  = short_stop_price
    risk = stop_price - entry_price
    tp_price = entry_price - risk * rr_ratio

    if exit_mode == "FixedRR"
        strategy.exit("Exit Short", from_entry="Short", stop=stop_price, limit=tp_price)
    else if exit_mode == "ATRTrail"
        strategy.exit("Exit Short", from_entry="Short", stop=stop_price, trail_offset=atr * atr_mult)
    else if exit_mode == "Hybrid"
        strategy.exit("TP1", from_entry="Short", stop=stop_price, limit=tp_price, qty_percent=50)
        strategy.exit("Trail Short", from_entry="Short", stop=stop_price, trail_offset=atr * atr_mult, qty_percent=50)

// === FORCE EXIT 16:45 NYT ===
closeAll = (barHour == 16 and barMinute > 50) or (barHour == 17 and barMinute < 5)
if closeAll and strategy.opentrades != 0
    strategy.close_all(comment="Session Close", immediately=true)

// === PLOTTING ===
plot(ema_chart, title="EMA21", color=color.purple, linewidth=2)
plot(sma_chart, title="SMA50", color=color.blue, linewidth=2)
plot(long_stop_price, "Long Stop Ref", color=color.red, style=plot.style_linebr)
plot(short_stop_price, "Short Stop Ref", color=color.green, style=plot.style_linebr)

// === DEBUG TABLE ===
var table debug = table.new(position.top_right, 6, 9, border_width=1)

if barstate.islast
    table.cell(debug, 0, 0, "Mode", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 0, exit_mode)
    table.cell(debug, 0, 1, "Stop Mode", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 1, stop_mode)
    table.cell(debug, 0, 2, "ATR", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 2, str.tostring(atr, format.mintick))
    table.cell(debug, 0, 3, "ATR Stop Long", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 3, str.tostring(atr_stop_long, format.mintick))
    table.cell(debug, 0, 4, "ATR Stop Short", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 4, str.tostring(atr_stop_short, format.mintick))
    table.cell(debug, 0, 5, "RR Ratio", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 5, str.tostring(rr_ratio, "#.##"))
    table.cell(debug, 0, 6, "Last Swing Low", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 6, str.tostring(last_pivot_low, format.mintick))
    table.cell(debug, 0, 7, "Last Swing High", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 7, str.tostring(last_pivot_high, format.mintick))
    table.cell(debug, 0, 8, "Prev Candle", text_color=color.white, bgcolor=color.blue)
    table.cell(debug, 1, 8, prev_bull ? "Bull" : prev_bear ? "Bear" : "Doji")
